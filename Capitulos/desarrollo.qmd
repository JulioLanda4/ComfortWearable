# Desarrollo, construcci칩n y validaci칩n


En esta secci칩n se describe el proceso completo de desarrollo, construcci칩n y validaci칩n del dispositivo presentado en esta tesis. La @sec-metodolog칤a aborda la metodolog칤a general del proyecto, incluyendo una descripci칩n detallada del dispositivo, la selecci칩n de los componentes y la justificaci칩n de su elecci칩n. En la @sec-construccion se desarrolla la etapa de dise침o y construcci칩n del dispositivo. La @sec-encuestas se centra en el dise침o y la implementaci칩n de las encuestas mediante la interfaz gr치fica, mientras que la @sec-calibraci칩n detalla el proceso de calibraci칩n de los sensores, para asegurar fiabilidad en las mediciones. En la @sec-programaci칩n se presenta la l칩gica de programaci칩n del dispositivo, y en la @sec-instrucciones se proporcionan instrucciones de uso. Finalmente, en la @sec-validaci칩n comprueba la funcionalidad del dispositivo para recopilar y almacenar informaci칩n de confort t칠rmico.


## Metodolog칤a {#sec-metodolog칤a}
1. **Descripci칩n general del dispositivo:**


El dispositivo presentado en esta tesis es un prototipo de reloj inteligente dise침ado espec칤ficamente para la investigaci칩n en el 치mbito del confort t칠rmico. Este dispositivo permite la recopilaci칩n de datos fisiol칩gicos, tales como la frecuencia card칤aca y la temperatura de la piel, variables cuya relaci칩n con el confort t칠rmico se discuti칩 en el cap칤tulo anterior. Adem치s, este dispositivo realiza encuestas peri칩dicas simplificadas de confort t칠rmico mediante una interfaz de usuario intuitiva, que permite responder la encuesta de forma r치pida y sencilla. La recopilaci칩n de estos datos se realiza en la plataforma de IoT llamada ThingsBoard, lo que permite la creaci칩n de una base de datos de confort t칠rmico en un bioclima c치lido semih칰medo [@infonavit2024regiones] en Temixco, Morelos. Esta base de datos facilitar치 estudios para el entendimiento del confort t칠rmico y el desarrollo de modelos de confort para este tipo de bioclima, as칤 como de modelos de confort personalizados.

2. **Selecci칩n de componentes** 

Para garantizar el funcionamiento preciso y adecuado del dispositivo, es fundamental seleccionar correctamente todos los componentes. A continuaci칩n se describen los principales componentes utilizados, junto con sus caracter칤sticas y la justificaci칩n de su elecci칩n en el proyecto. Esta justificaci칩n se basa en criterios como compatibilidad, consumo energ칠tico, precisi칩n y capacidad de procesamiento en el caso del microcontrolador.

Los componentes principales son los siguientes: 

* Placa de desarrollo
* Pantalla
* Bater칤a 
* Sensores

**Placa de desarrollo**

La selecci칩n de la tarjeta o placa de desarrollo es una decisi칩n crucial en el desarrollo del proyecto. Se requiere una placa de tama침o reducido que cumpla con caracter칤sticas esenciales como conexi칩n WiFi, velocidad de procesamiento, memoria y comunicaci칩n I2C. Adem치s, debe tener un bajo consumo energ칠tico para garantizar el uso port치til prolongado del dispositivo.

Se buscan placas compactas con conectividad inal치mbrica. Opciones con microcontroladores como los de Arduino, ESP y Raspberry ofrecen estas caracter칤sticas.

Durante el proceso de selecci칩n se identifican dos placas con pantallas integradas, que aunque podr칤an ser 칰tiles, no cumplen con los requisitos del proyecto. La placa LILYGO TTGO, no cuenta con tecnolog칤a t치ctil, lo cual limita su utilidad para realizar encuestas de confort t칠rmico. Por otro lado, la MCU RP2040 con LCD redondo de 1.28 pulgadas, aunque cuenta con una pantalla t치ctil, no ofrece conectividad WiFi, un requisito esencial. Aunque estas dos placas no son tomadas en cuanta por las razones ya mencionadas, sirven como referencia para la b칰squeda de otras opciones. En la tabla @tbl-placas se presenta una comparaci칩n de diferentes placas de desarrollo con las caracter칤sticas requeridas.

| Placa de desarrollo          | Wifi | Bluetooth | Comunicaci칩n                    | Cable       | Pines         |
|------------------------------|------|-----------|---------------------------------|-------------|---------------|
| Arduino Nano 33 IoT         | si   | 4.2       | SPI, I2C, I2S, UART            | Micro USB   | 30 GPIOS, 8 ADC   |
| Arduino nano esp32          | si   | LE        | UART, I2C, SPI, I2S, CAN(TWAI)  | USB C       |    22 GPIOS, 8 ADC           |
| Arduino nano RP2040 connect | si   | si        | STI, I2C, I2S, PIO, UART       | USB C       | 30 GPIOS, 8 ADC  |
| Raspberry pi pico W         | si   | 5.2       | UART, I2C, SPI                 | Micro USB   | 26 GPIOS, 3 ADC  |
| ESP32 pico kit              | si   | si        | I2C, I2S, SPI                  | Micro USB   | 34 GPIOS      |
| Seeed Studio XIAO ESP32C3   | si   | 5         | 1x UART, 1x IIC, 1x SPI       | USB C       | 11 GPIOS, 4 ADC |
| Seeed Studio XIAO ESP32S3   | si   | 5         | 1x UART, 1x IIC, 1x SPI       | USB C       | 11 GPIOS, 9 ADC |
: Comparaci칩n de caracter칤sticas de conectividad y hardware en placas de desarrollo {#tbl-placas}

Si bien todas las placas presentadas son opciones viables, Seeed Studio ha desarrollado placas orientadas a aplicaciones de dispositivos port치tiles. Estas placas empatan perfectamente con las necesidades del proyecto debido a su tama침o compacto, conectividad, modos de bajo consumo y la posibilidad de la integraci칩n con una pantalla t치ctil desarrollada por la misma marca. Para el desarrollo del proyecto, se elige la XIAO ESP32C3 sobre la XIAO ESP32S3. Aunque la primera es menos potente, cumple con todos los requerimientos a un menor costo. No obstante, la XIAO ESP32S3 podr칤a ser usada sin ning칰n problema, ofreciendo incluso aumentar considerablemente la capacidad de memoria para futuras modificaciones o mejoras en el c칩digo. La @tbl-esp muestra las caracter칤sticas especificas de la placa seleccionada.


| Parametro                              | Seeed Studio XIAO ESP32C3 |
|-------------------------------------------|----------------------------|
| Procesador                                 | ESP32-C3 32 bit<br>RISC-V<br>160 MHz                                                                  
| Conectividad                                  | 2.4 GHz WiFi<br>BLE: Bluetooth 5.0, Bluetooth mesh     
| On-chip Memory                            | 400 KB SRAM & 4 MB Flash        |
| Interfaz                                | 1x UART, 1x IIC, 1x SPI,<br>11x GPIO(PWM), 4x ADC, 1x Reset button, 1x Boot button                     |
| Dimensiones                               | 21 x 17.8 mm                |
| Caracter칤sticas el칠ctricas                                     | Voltaje de entrada (Typo-C): 5 V<br>Voltaje de operaci칩n 3.3 V  |
|                                           | Circuit operating Voltage (ready to operate):<br>- Type-C: 5 V@19mA <br>- BAT: 3.8 V@22mA           |
|                                           | corriente de carga de bateria: 350 mA/100 mA                      |
| Modo de bajo consumo                         | Modo deep-sleep: > 44 췃A  |
| WiFi activado Consumo de energ칤a           | Modo activo: < 75 mA     |
| Bluetooth activado Consumo de energ칤a             | Modo modem-sleep: < 27 mA      |
| Temperatura de trabajo                      | -40 춿C ~ 85 춿C               |
: Especificaciones t칠cnicas detalladas de la placa XIAO ESP32C3 {#tbl-esp} 


**Pantalla**

La elecci칩n de la pantalla debe alinearse con los criterios establecidos para la placa de desarrollo. se busca una pantalla que ademas de ser de tama침o reducido, sea compatible con la placa seleccionada. En la tabla @tbl-screen, se presentan las caracter칤sticas b치sicas de las pantallas consideradas durante el proceso.

| Pantalla                                   | touchscreen | tecnolog칤a | dimensi칩n |
|--------------------------------------------|-------------|------------|----------|
| Seeed Studio Round Display for XIAO        | si          | TFT LCD    | 1.28''   |
| Waveshare M칩dulo de visualizaci칩n           | no          | OLED RGB   | 1.5''    |
| GC9A01 Pantalla                            | no          | TFT LCD    | 1.28''   |
: Comparacion de pantallas compatibles con la XIAO ESP32C3 {#tbl-screen}


La pantalla seleccionada es la Seeed Studio Round Display for XIAO. Este modelo es perfectamente compatible con la placa XIAO ESP32C3, elegida previamente, gracias al enfoque de Seeed Studio para desarrollar un ecosistema orientado a aplicaciones de dispositivos port치tiles. La compatibilidad entre los componentes, tecnolog칤a t치ctil y dise침o redondo, logran que la pantalla se ajuste a las necesidades del proyecto.


**Sensor de temperatura**

La @tbl-temp muestra una comparaci칩n entre distintos sensores de temperatura que podr칤an ser utilizados en el proyecto, incluyendo termistores, sensores infrarrojos y un sensor de temperatura y humedad. Estos sensores se manejan en un rango de operaci칩n entre los 3.3 V y 5.0 V para garantizar su compatibilidad con la placa de desarrollo seleccionada.


| Caracter칤stica            | Tipo de sensor                      | Rango de temperatura               | Precisi칩n                             | Comunicaci칩n                          |
|---------------------------|-------------------------------------|------------------------------------|---------------------------------------|---------------------------------------|
| **GY-906 (MLX90614)**     | Sensor de temperatura infrarrojo    | -70춿C a 382.2춿C                    | 췀0.5춿C (0춿C a 50춿C)                   | I2C                                   |
| **ZTP-115M**              | Sensor de temperatura infrarrojo    | -20춿C a 100춿C                      | 췀1춿C (32춿C a 42춿C)                    | Salida anal칩gica                      |
| **NTC MF52AT**            | Termistor NTC                       | -55춿C a 125춿C                      | 췀0.2춿C (dependiendo de la resistencia) | Ninguna (sensor resistivo)            |
| **BetaTherm 10K3A1**      | Termistor NTC                       | -50춿C a 150춿C                      | 췀0.2춿C (25춿C a 45춿C)                  | Ninguna (sensor resistivo)            |
| **AHT20**                 | Sensor de temperatura y humedad digital | -40춿C a 85춿C                       | 췀0.3춿C (temperatura) / 췀2% HR (humedad)| I2C                                   |
: Comparaci칩n de Sensores de Temperatura por Rango Operativo y Precisi칩n {#tbl-temp}

Tras un an치lisis detallado, se selecciona el sensor GY-906 debido a su tama침o compacto, dise침o adecuado y comunicaci칩n digital por I2C. Aunque el termistor NTC MF52AT ofrece una alternativa viable, se descarta por ser un sensor anal칩gico. Dado que el dispositivo est치 dise침ado para operar en un espacio reducido, cualquier interferencia en las conexiones internas podr칤a afectar la precisi칩n de los sensores anal칩gicos. Por esta raz칩n, se opta por el GY-906, que garantiza una transmisi칩n de datos confiable y estable en entornos compactos.

**Sensor de pulso card칤aco**

Los sensores 칩pticos se han consolidado como una buena opci칩n para la medici칩n de la frecuencia card칤aca en dispositivos port치tiles. Maxim Integrated ofrece la l칤nea de sensores MAX3010X para este tipo de aplicaciones. Estos sensores destacan por su bajo consumo de energ칤a, precio accesible, tama침o compacto y protocolo de comunicaci칩n I2C. La @tbl-pulso muestra una comparaci칩n entre los sensores MAX20100, MAX30102 y MAX30105.


| **Sensor**      | **Tipo de almacenamiento**   |  **Resoluci칩n ADC**   |  **Funcionalidades**         | **Consumo de Energ칤a**  |
|-----------------|----------------------|--------|-----------------------------|-------------------------|
| **MAX30100**    | 16-bit FIFO     |   14-bit   | Frecuencia card칤aca y SpO2          | 600 췃A a 1 mA           |
| **MAX30102**    | 32-bit FIFO     |   18-bit   | Frecuencia card칤aca, SpO2| 600 췃A a 1.2 mA         |
| **MAX30105**    | 32-bit FIFO     |   18-bit   | Frecuencia card칤aca, SpO2, detecci칩n de part칤culas | 600 췃A a 1.2 mA |
: Comparaci칩n de Sensores de frecuencia card칤aca  {#tbl-pulso}

El MAX30102 se elige como la mejor opci칩n para este proyecto por su equilibrio entre funcionalidad, costo y tama침o. A comparaci칩n del MAX30105, este es m치s econ칩mico y m치s compacto. La funcionalidad de detecci칩n de part칤culas no es de inter칠s para este proyecto. Adem치s, el MAX30102 ofrece mejoras significativas respecto al MAX30100, tanto en la resoluci칩n como en el tipo de almacenamiento. La medici칩n de oxigenaci칩n en la sangre no es una caracter칤stica actual del dispositivo planteado en esta tesis, pero podr칤a ser una variable de inter칠s en investigaciones futuras.


**Circuito vibrador**

El dispositivo cuenta con un sistema de alarma silenciosa compuesta por un motor vibrador circular de 8 mm de di치metro, alimentado a 3.7 V y un circuito de control. La @fig-circuito_motor muestra este circuito. 

![Circuito de control del motor vibrador](../Imagenes/Circuito_motor.png){#fig-circuito_motor width=50%}



**Bater칤a**

El uso de bater칤as de pol칤mero de litio (LiPo) es ampliamente utilizado en dispositivos port치tiles debido a sus caracter칤sticas de peque침o tama침o, bajo peso y facilidad de carga. Para este proyecto, que integra una placa de desarrollo XIAO ESP32C3, una pantalla XIAO Round Display, un sensor GY-906, un sensor MAX30102 y un circuito vibrador, es crucial seleccionar una capacidad de bater칤a que asegure un funcionamiento continuo y confiable, considerando el consumo energ칠tico de cada componente involucrado.

La XIAO ESP32C3 presenta un consumo promedio de 74.7 mA durante su operaci칩n activa [@xiaoesp32c3], mientras que la pantalla XIAO Round Display demanda aproximadamente 70.0 mA [@xiaodisplay]. Por su parte, el sensor GY-906 tiene un consumo de corriente bajo, en el rango de 1.0 a 2.0 mA [@mlx90614_datasheet], el sensor MAX30102 consume entre 0.6 y 1.2 mA durante la medici칩n de la frecuencia card칤aca [@max30102_datasheet]. Adicionalmente, el motor vibrador registra un consumo estimado de 84.0 mA [@uelectronics_vibration_motor], dependiendo de la intensidad de la vibraci칩n y la carga aplicada.

El consumo total del dispositivo en condiciones de operaci칩n m치xima puede alcanzar 232.0 mA. Sin embargo, este nivel de consumo es poco probable alcanzarse durante el uso t칤pico del dispositivo,ya que, durante la mayor parte del tiempo los sensores y la pantalla permanecen inactivos y solo se encenderan al momento de llevar a cabo sus mediciones; el motor vibrador se enciende 칰nicamente por breves periodos cada hora. Con el fin de asegurar autonom칤a del dispositivo y evitar interrupciones en su funcionamiento, se selecciona una bater칤a de 650.0 mAh. Este capacidad satisface los requisitos energ칠ticos, permitiendo el uso prolongado del dispositivo. Adem치s, la bater칤a seleccionada cumple en tama침o y peso, ajust치ndose adecuadamente al dise침o del dispositivo.


La @tbl-componentes-seleccionados muestra todos los componentes seleccionados para el desarrollo del dispositivo. 


| **Componente**             | **Descripci칩n**                                            |
|----------------------------|------------------------------------------------------------|
| XIAO ESP32C3               | Placa de desarrollo compacta con Wi-Fi y BLE                  |
| XIAO Round Display         | Pantalla circular t치ctil de 1.28 pulgadas                  |
| GY-906                     | Sensor infrarrojo de temperatura sin contacto              |
| MAX30102                   | Sensor 칩ptico de frecuencia card칤aca           |
| Circuito vibrador          | Circuito vibrador para notificaciones silenciosas             |
| Bater칤a 650 mAh            | Bater칤a LiPo recargable      |
: Tabla de componentes seleccionados  {#tbl-componentes-seleccionados}




3. **Dise침o del dispositivo**



Una vez seleccionados los componentes principales del dispositivo, el dise침o se centra en crear una carcasa compacta y adecuada en donde los componentes puedan colocarse sin interferir entre ellos y as칤 mismo el desarrollo de los circuitos internos de conexi칩n

**Carcasa:**

La carcasa del dispositivo esta dise침ada para ser impresa en 3D y consta de tres partes principales y un seguro. La primera parte es la base y esta es la que est치 en contacto con la mu침eca del usuario, cuenta con ranuras para el acomodo y fijaci칩n de los sensores y que estos queden en contacto directo con la piel para llevar a cabo las mediciones de forma adecuada

La parte central de la carcasa es la pieza que va arriba de la base y es donde se aloja el microcontrolador, el motor vibrador y el interruptor de encendido. La pieza est치 dise침ada con compartimentos para fijar cada uno de estos componentes. Por la parte exterior de la carcasa, esta pieza cuenta con ranuras para colocar las correas que fijan el dispositivo a la mu침eca del usuario.

La parte superior de la carcasa est치 dise침ada con el fin de mantener la pantalla t치ctil en su posici칩n y cerrar el dispositivo. Todas las piezas se ensamblan una con otra por presi칩n, evitando el uso de tornillos.

Adicional, hay una cuarta pieza que es un seguro para fijar el interruptor de encendido. Esta se coloca por encima del interruptor una ve est칠 colocado en su posici칩n en la pieza central. El seguro ensambla por presi칩n a la pieza y deja fijo el interruptor.

En la @fig-partescase Se observan las tres piezas principales de la carcasa.

![Diagrama de conexiones](../Imagenes/PartesCase.png){#fig-partescase width=75%}

**Dise침o de los circuitos**

El dise침o de los circuitos se divide en tres circuitos, circuito vibrador para alarma @fig-conexiones a) , circuito de sensores y
microcontrolador @fig-conexiones b) y el circuito de la bater칤a @fig-conexiones c). Cada uno de estos circuitos est치 dise침ado para mantener las conexiones lo m치s simples y cortas posibles. Dado que la placa XIAO ESP32C3 y la pantalla XIAO Round Display se ensamblan directamente, se omite ese circuito.

![Diagrama de conexiones](../Imagenes/Diagrama%20de%20conexiones.png){#fig-conexiones}

El c칩digo de colores utilizado en este proyecto, para facilitar las conexiones, es:

* ***Rojo:*** Conexi칩n Vcc (3,3 V).
* ***Negro:*** GND.
* ***Azul:*** cable de comunicaci칩n SCL.
* ***Blanco:*** cable de comunicaci칩n SDA.
* ***Verde:*** se침al de activaci칩n del motor.
* ***Amarillo:*** conexi칩n entre el pin emisor del transistor y el motor vibratorio.

El circuito vibrador es un circuito sencillo de control de motor. Este circuito tiene la finalidad de proteger el microcontrolador al evitar que el motor se alimente directamente del pin digital del microcontrolador, si no que lo haga directamente de la alimentaci칩n general del dispositivo, dejando al pin del microcontrolador 칰nicamente la tarea de dar la se침al de activaci칩n.

El circuito de los sensores y el microcontrolador tiene la funci칩n de comunicar de forma paralela ambos sensores por protocolo I2C al microcontrolador.

El circuito de la bater칤a sirve para a침adir el interruptor de encendido y agregar un conector JST, el cual se conecta a la pantalla XIAO Round Display.

En resumen, el dise침o del dispositivo est치 enfocado en optimizar las conexiones, el espacio y facilitar su montaje, esto a la vez que se asegura su funcionalidad y ergonom칤a.


## Construcci칩n del dispositivo {#sec-construccion}

La construcci칩n del dispositivo en tres etapas: La impresi칩n de la carcasa, la conexi칩n de los componentes electr칩nicos y la integraci칩n y montaje de todos los elementos.

***Carcasa:*** los archivos STL para la impresi칩n de la carcasa los puedes encontrar en el <a href="https://github.com/JulioLanda4/Reloj_Confort" target="_blank">repositorio del proyecto</a>

 

***Componentes electr칩nicos:*** Las conexiones de los componentes electr칩nicos se llevan a cabo siguiendo los diagramas de @fig-conexiones. Es importante seguir correctamente los diagramas para facilitar posteriormente su acomodo dentro de la carcasa. 

***Integraci칩n y montaje:*** Una vez realizadas las conexiones, se lleva a cabo el montaje de los circuitos dentro de la carcasa, esta se ensambla y se colocan las correas.

En el articulo XXX puede encontrar informaci칩n m치s detallada acerca del dise침o y los pasos a seguir para la construcci칩n del dispositivo.


## Encuestas e interfaz {#sec-encuestas}

Una de las principales caracter칤sticas del reloj inteligente presentado, es la capacidad de realizar encuestas de confort t칠rmico de manera peri칩dica y en condiciones reales con el prop칩sito de recolectar datos que permitan estudiar la percepci칩n de confort t칠rmico en el Instituto de Energ칤as Renovables (IER) de la UNAM. A continuaci칩n se describe la metodolog칤a de implementaci칩n de las encuestas, la l칩gica de la interfaz y las funcionalidades que permiten la interacci칩n eficiente entre el usuario y el dispositivo.

1. Dise침o de las Encuestas

El reloj inteligente lleva a cabo encuestas simplificadas de confort t칠rmico cada hora, en horarios espec칤ficos entre las 8:00 a. m. y las 9:00 p. m., programadas en las medias horas para alinearse con los horarios de actividades en el IER, permitiendo al usuario aclimatarse antes de responder la encuesta. Al llegar el momento de responder la encuesta, el dispositivo activa una alarma vibradora que consta de tres pulsos cortos en un lapso de un segundo, para notificar al usuario. Si el usuario ignora la alarma, el bot칩n de 'Encuesta' permanece activo hasta que se complete la encuesta, si despu칠s de quince minutos la encuesta no ha sido respondida, la alarma se vuelve a activar una vez m치s. Si esta segunda notificaci칩n es ignorada, la alarma no se activa nuevamente hasta la pr칩xima hora programada. 

La encuesta consta de cinco preguntas. Las preguntas seleccionadas se basan en XXX Podr칤a mencionarse a Ibet o buscar la referencia en las notas de la clase con Guadalupe. Las cinco preguntas son las siguientes:

- Vestimenta: Presenta la pregunta: "쮺u치l es tu vestimenta actual?" donde el usuario puede seleccionar todas las prendas que este usando de una lista predefinida. El objetivo de esta pregunta es calcular el nivel de aislamiento t칠rmico del usuario (CLO). La interfaz muestra el c치lculo del valor de CLO en la parte inferior de la pantalla a medida que se seleccionan o deseleccionan las prendas. La @tbl-prendas muestra la lista de prendas disponibles para seleccionar con su respectivo calor de CLO.

| **Prenda**          | **Valor de CLO** |
|---------------------|------------------|
| Zapato              | 0.02             |
| Calz칩n              | 0.04             |
| Playera             | 0.09             |
| Camisa              | 0.15             |
| Pantal칩n            | 0.25             |
| Calcetines          | 0.02             |
| Sombrero            | 0.05             |
| Bufanda             | 0.10             |
| Guantes             | 0.10             |
| Chaqueta            | 0.30             |
| Su칠ter              | 0.18             |
| Falda               | 0.14             |
| Shorts              | 0.06             |
| Vestido             | 0.15             |
| Pantal칩n de mezclilla| 0.23            |
| Abrigo              | 0.40             |
| Gorro de lana       | 0.08             |
| Bata de ba침o        | 0.30             |
| Chaleco             | 0.10             |
| Botas               | 0.10             |
| Impermeable         | 0.20             |
| Sandalias           | 0.02             |
| Brasier             | 0.02             |
| Corpi침o             | 0.03             |
: Tabla de equivalencia de prendas a CLO {#tbl-prendas}

- Actividad: Presenta la pregunta: "쯈u칠 actividad est치s realizando?" donde el usuario selecciona una 칰nica opci칩n de una lista predefinida de actividades que permiten calcular la tasa metab칩lica (MET) del usuario. La @tbl-actividad muestra la lista de actividades con su respectivo valor de MET asociado.

| **Actividad**              | **Valor de MET** |
|----------------------------|------------------|
| Tomando clase sentado      | 1.3              |
| Tomando clase de pie       | 1.8              |
| Dando clase sentado        | 2.0              |
| Dando clase de pie         | 2.3              |
| Caminando                  | 2.9              |
| Comiendo                   | 1.5              |
| Escribiendo                | 1.3              |
| Trabajando en computadora  | 1.5              |
| De pie en un laboratorio   | 2.0              |
: Tabla equivalencia de actividades a MET  {#tbl-actividad}

- Ubicaci칩n: Se presenta la pregunta: "쮻onde te encuentras?" donde el usuario selecciona una 칰nica opci칩n de una lista predefinida de ubicaciones 맋entro del IER UNAM.

- Escala de confort t칠rmico: Se presenta la pregunta: "쮺u치l es tu sensaci칩n t칠rmica en este momento?" donde el usuario puede elegir su sensaci칩n t칠rmica actual en un rango de -3 a 3 en intervalos de 0.5. Cada valor tiene una descripci칩n asociada de la sensaci칩n t칠rmica. La @tbl-tsv muestra la descripci칩n asociada a cada uno de los valores del voto de sensaci칩n t칠rmica.

| Valor de Sensaci칩n T칠rmica | Descripci칩n           |
|---------------------------|-----------------------|
| -3                        | Helado                |
| -2.5                      | Mucho fr칤o            |
| -2                        | Fr칤o                  |
| -1.5                      | Ligeramente fr칤o      |
| -1                        | Fresco                |
| -0.5                      | Ligeramente fresco    |
| 0                         | Neutro                |
| 0.5                       | Ligeramente templado  |
| 1                         | Templado              |
| 1.5                       | Ligeramente caluroso  |
| 2                         | Caluroso              |
| 2.5                       | Muy caluroso          |
| 3                         | Ardiendo              |
: Escala del voto de sensaci칩n t칠rmica con su descripci칩n  {#tbl-tsv}

- Aceptaci칩n T칠rmica: Finalmente, se presenta la pregunta: "쮸ceptas la sensaci칩n t칠rmica actual?", donde el usuario puede responder "S칤" o "No". Esta pregunta busca evaluar si, independientemente de la sensaci칩n t칠rmica reportada, el usuario la percibe como aceptable.

2. Interfaz de Usuario

La interfaz del dispositivo ha sido dise침ada utilizando la biblioteca LVGL, que ofrece herramientas para la creaci칩n de interfaces gr치ficas en microcontroladores integrados con pantallas t치ctiles. Cada una de las preguntas descritas previamente se presenta en una pantalla distinta, permitiendo al usuario navegar de manera intuitiva y sencilla.

- Navegaci칩n entre Pantallas: Cada pantalla tiene botones laterales para avanzar o retroceder entre las preguntas de la encuesta. Una vez completadas todas las preguntas, el usuario puede presionar el bot칩n "Finalizar".

- Interacci칩n con Pantallas: Cada pantalla que presenta una lista predefinida de opciones cuenta con botones para moverse entre las diferentes opciones disponibles. Esto permite al usuario seleccionar f치cilmente la opci칩n deseada, asegurando una interacci칩n fluida y precisa con el dispositivo.

3. Funcionalidades Adicionales y Validaci칩n

Una vez que se completa la encuesta, al pulsar el bot칩n "Finalizar", aparece un mensaje emergente que solicita al usuario mantenerse inm칩vil mientras que los sensores de frecuencia card칤aca (MAX30102) y de temperatura de la piel (GY-906) llevan a cabo sus mediciones correspondientes, estas mediciones se realizan en un lapso de diez segundos. Los resultados se muestran al usuario para su validaci칩n. Si el usuario considera que los resultados son coherentes, puede enviarlos; de lo contrario, tiene la opci칩n de repetir las mediciones.

Los datos recolectados son enviados a la plataforma Thingsboard para su almacenamiento y an치lisis posterior. Esta funcionalidad permite construir una base de datos que facilite el estudio del confort t칠rmico en diferentes espacios y condiciones dentro del IER.

La @fig-generica muestra todas las pantallas

![Imagen generica](../Imagenes/ImagenGenerica.png){#fig-generica width=50%}



## Calibraci칩n {#sec-calibraci칩n}



La calibraci칩n de los sensores en el dispositivo es esencial para garantizar la precisi칩n y confiabilidad de las mediciones. Esta secci칩n describe el proceso de calibraci칩n de los sensores MAX30102 y GY-906, utilizados para medir la frecuencia card칤aca y la temperatura de la piel, respectivamente.

### Calibraci칩n del Sensor MAX30102

Para la calibraci칩n del sensor MAX30102, se utiliza como referencia un ox칤metro de pulso Yonker YK-81C, que ofrece una precisi칩n de 췀 1 bpm. Dado que las mediciones del reloj inteligente se realizan en intervalos de 10 segundos, este mismo periodo se emplea durante el proceso de calibraci칩n. El sensor se configura mediante Arduino y la librer칤a de SparkFun para los sensores MAX3010X. La calibraci칩n se enfoca en la configuraci칩n 칩ptima de varios par치metros ajustables: `ledBrightness`, `sampleAverage`, `ledMode`, `sampleRate`, `pulseWidth`, `adcRange` y `RATE_SIZE`.

- **ledBrightness** (0 - 255): Controla la intensidad de los LED infrarrojo y rojo, afectando la penetraci칩n de la luz en el tejido de la piel y, en consecuencia, la calidad de la se침al obtenida. Un valor m치s alto aumenta la intensidad de la luz, mejorando la detecci칩n en condiciones de baja perfusi칩n, pero incrementa el consumo de energ칤a.
- **sampleAverage** (1, 2, 4, 8, 16, 32): Define cu치ntas muestras se promedian antes de almacenarse en la memoria FIFO. Un mayor promedio reduce el ruido y estabiliza la se침al, a costa de reducir la capacidad de respuesta a cambios r치pidos.
- **ledMode** (1 - 3): Establece el modo de operaci칩n del sensor. El valor 1 utiliza solo el LED rojo, el valor 2 emplea tanto el LED rojo como el infrarrojo para medir la frecuencia card칤aca y la saturaci칩n de ox칤geno, y el valor 3 incluye un tercer LED verde en algunos modelos de la serie MAX3010X.
- **sampleRate** (50, 100, 200, 400, 800, 1000, 1600, 3200 Hz): Define la frecuencia con la que se toman las muestras de la se침al, afectando la resoluci칩n temporal y la capacidad de captar variaciones r치pidas en la frecuencia card칤aca. Una mayor frecuencia proporciona una mejor resoluci칩n temporal, pero puede aumentar el ruido si la se침al no se filtra adecuadamente.
- **pulseWidth** (69, 118, 215, 411 췃s): Controla la duraci칩n del pulso de luz emitido por los LED. Un mayor ancho de pulso mejora la resoluci칩n de las mediciones, pero tambi칠n incrementa el consumo de energ칤a del sensor y la cantidad de luz reflejada, lo cual puede saturar el ADC en ciertos tipos de piel.
- **adcRange** (2048, 4096, 8192, 16384 nA): Establece el rango de entrada del convertidor anal칩gico-digital. Aumentar el rango permite al sensor manejar se침ales m치s intensas sin saturarse, mientras que un rango menor mejora la sensibilidad para se침ales d칠biles.
- **RATE\_SIZE** (tama침o del buffer): Determina el tama침o del buffer para el c치lculo de la frecuencia card칤aca. Este par치metro afecta la cantidad de datos utilizados para calcular la frecuencia card칤aca promedio. Aumentar el tama침o del buffer de 4 a 6 mejora la precisi칩n de las lecturas, ya que permite una mayor estabilidad en los c치lculos.

Inicialmente, los par치metros se configuran con valores predeterminados, pero los resultados muestran un error absoluto medio (MAE) de 18.5 bpm respecto al ox칤metro de referencia, lo cual no es aceptable. Para mejorar la precisi칩n, se exploran valores extremos del par치metro `RATE_SIZE`, variando desde 1 hasta 100. Con `RATE_SIZE` igual a 1, se obtienen resultados r치pidos pero poco precisos, mientras que con `RATE_SIZE` igual a 100, se logra alta precisi칩n, pero se requieren m칰ltiples intervalos de 10 segundos, incrementando el tiempo total de medici칩n. Para encontrar un equilibrio entre precisi칩n y tiempo de medici칩n, se eval칰an valores intermedios de `RATE_SIZE` entre 4 y 16. El valor 칩ptimo encontrado es `RATE_SIZE` igual a 6, lo cual reduce el MAE a 4.4 bpm.

La @tbl-max30102 muestra el error absoluto medio (MAE) obtenido para diferentes valores de `RATE_SIZE` entre 4 y 16, destacando que el mejor valor para `RATE_SIZE` es 6:

| N칰mero de Mediciones | RATE\_SIZE | MAE (bpm) |
| -------------------- | ---------- | --------- |
| 20                   | 4          | 18.5      |
| 20                   | 6          | 4.4       |
| 20                   | 8          | 12.0      |
| 20                   | 10         | 19.6      |
| 20                   | 12         | 7.7       |
| 20                   | 14         | 13.6      |
| 20                   | 16         | 15.8      |
: sdfsdfsd  {#tbl-max30102}

Posteriormente, con RATE\_SIZE fijado en 6, se ajusta el valor de sampleAverage de 4 a 8, logrando un MAE de 3.6 bpm, lo cual representa una mejora en la estabilidad de la se침al. La configuraci칩n final optimizada incluye los siguientes valores: ledBrightness en 31, sampleAverage en 8, ledMode en 2, sampleRate en 400, pulseWidth en 411, adcRange en 2048 y RATE\_SIZE en 6.

### Calibraci칩n del Sensor GY-906

Para la calibraci칩n del sensor de temperatura GY-906, se utiliza una c치mara termogr치fica Fluke Ti9 como referencia. Tanto el sensor como la c치mara se configuran con una emisividad de 0.98, correspondiente a la emisividad promedio de la piel humana. Las pruebas se realizan durante tres d칤as, entre las 10:00 a. m. y las 6:00 p. m., con mediciones cada media hora para capturar diferentes condiciones ambientales.

Durante cada sesi칩n de medici칩n, el sensor GY-906 realiza diez mediciones consecutivas en un lapso de diez segundos, y el promedio de estas mediciones se env칤a a la plataforma Thingsboard, lo cual permite reducir el ruido y aumentar la precisi칩n. Simult치neamente, las lecturas de la c치mara termogr치fica se registran manualmente. Para minimizar el error por movimiento, el dispositivo emite una alerta vibratoria de un segundo, seguida de una pausa de cuatro segundos antes de realizar la medici칩n, permitiendo al usuario mantener la mano inm칩vil durante el proceso de medici칩n. Se obtienen 61 pares de mediciones, la @tbl-estadisticas-camara muestra las caracter칤sticas estad칤sticas de ambos conjuntos de datos, mientras que la @fig-dispersion muestra un gr치fico de dispersi칩n de datos entre las lecturas hechas por el sensor y las lecturas hechas por la c치mara.

| Estad칤stica          | Sensor (춿C) | C치mara (춿C) |
|----------------------|-------------|-------------|
| Media                | 34.58       | 35.30       |
| Desviaci칩n est치ndar  | 0.75        | 0.63        |
| M칤nimo               | 32.36       | 32.80       |
| M치ximo               | 35.83       | 35.83       |
: Estad칤sticas de las Mediciones del Sensor GY-906 y la C치mara Termogr치fica Fluke Ti9  {#tbl-estadisticas camara}

```{python}
#| echo: false
#| fig-cap: "Gr치fico de Dispersi칩n de las Mediciones del Sensor GY-906 y la C치mara Termogr치fica Fluke Ti9"
#| label: fig-dispersion

import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

ruta_excel = "../datos/DatosTemperatura.xlsx"
datos = pd.read_excel(ruta_excel, sheet_name="Sheet1")

# Crear la figura con subplots
fig, ax = plt.subplots(figsize=(5, 5))

px = [30,40]
py = [30,40]

ax.plot(px,py,"r--", label="L칤nea de identidad")

ax.scatter(datos["Sensor"], datos["Camara"], s=25, alpha=0.4,label="Datos")

# Configurar la leyenda y los ejes
ax.set_xlabel("Sensor GY-906 [춿C]")
ax.set_ylabel("C치mara Fluke Ti9 [춿C]")
ax.grid()

# Calcular los l칤mites de la gr치fica para el primer subplot
limite_max_primero = datos[["Camara", "Sensor"]].max().max() + 0.1
limite_min_primero = datos[["Camara", "Sensor"]].min().min() - 0.1
ax.set_xlim(limite_min_primero, limite_max_primero)
ax.set_ylim(limite_min_primero, limite_max_primero)
        
plt.legend()
plt.legend(loc='lower right')
#plt.savefig('Scatter.png', dpi=1000)
plt.show()
```


El an치lisis de los resultados revela un error sistem치tico, ya que el sensor GY-906 tiende a medir temperaturas ligeramente inferiores a las registradas por la c치mara termogr치fica. Las estad칤sticas de los errores son las siguientes: 

- Error Promedio (EM): -0.72춿C
- Error Absoluto Medio (EAM): 0.77춿C

La @fig-histograma muestra un histograma del error de medici칩n, donde se puede observa el error sistem치tico del sensor respecto a la c치mara. Se observa que la mayor칤a de los errores se concentran entre 0 y 0.5춿C.

```{python}
#| echo: false
#| fig-cap: "Histograma de errores entre las mediciones de la c치mara Fluke Ti9 y el sensor GY-906"
#| label: fig-histograma

error = datos.Sensor - datos.Camara

# Crear el histograma
fig, ax = plt.subplots()
ax.hist(error, bins=20, range=(-2.5, 2.5), zorder=3)
ax.set_xlabel("Error [춿C]")
ax.set_ylabel("Frecuencia")

ax.xaxis.set_minor_locator(plt.MultipleLocator(0.250))  # Define el intervalo de los ticks menores

# Configurar la cuadr칤cula
ax.grid(which='minor', linestyle='--', linewidth=0.5, color='gray', zorder=0)
ax.grid(which='major', linestyle='-', linewidth=0.5, color='gray', zorder=0) 

#plt.savefig('Histogram.png', dpi=300)
plt.show()

```

Para garantizar que la calibraci칩n del sensor GY-906 no utilice datos que puedan distorsionar el an치lisis, se utiliza el m칠todo de la envolvente el칤ptica, con el que se asegura que solo los datos m치s representativos y precisos sean utilizados para el proceso de calibraci칩n del sensor. Con este m칠todo se detectan siete valores at칤picos o outliers los cuales son excluidos del conjunto de datos para el proceso de calibraci칩n. En la @fig-outliers se observan los valores at칤picos detectados y excluidos.

```{python}
#| echo: false
#| fig-cap: "Valores at칤picos detectados del conjunto de mediciones"
#| label: fig-outliers

from sklearn.covariance import EllipticEnvelope

# Ajustar la Envolvente El칤ptica
outlier_model = EllipticEnvelope(contamination=0.1)
outlier_model.fit(error.values.reshape(-1, 1))
labels = outlier_model.predict(error.values.reshape(-1, 1))

# Crear la figura con subplots
fig, ax = plt.subplots(figsize=(5, 5))

# L칤nea de identidad
px = [min(datos['Sensor']), max(datos['Sensor'])]
py = [min(datos['Sensor']), max(datos['Sensor'])]
ax.plot(px, py, "r--", label="L칤nea de identidad")

# Dibujar todos los datos
ax.scatter(datos['Sensor'], datos['Camara'], s=25, alpha=0.6, label="Datos")

# Dibujar solo los outliers encima
outliers = labels == -1
ax.scatter(datos['Sensor'][outliers], datos['Camara'][outliers], color='red', s=25, edgecolors='k', label="Valores at칤picos")

# Configurar la leyenda y los ejes
ax.set_xlabel("Sensor [춿C]")
ax.set_ylabel("C치mara [춿C]")
ax.grid(True)
ax.legend()
plt.legend(loc='lower right')
plt.show()

```


Posteriormente, se utiliza el m칠todo de calibraci칩n de punto, el cual ajusta el error a trav칠s de un factor de correcci칩n constante para alinear las mediciones del sensor con un est치ndar de referencia, en este caso las mediciones de la c치mara. Para obtener este factor se usa un m칠todo iterativo que eval칰a diferentes factores de correcci칩n dentro de un rango definido. Este rango se define utilizando el EAM y la desviaci칩n est치ndar de los errores (洧랥). El margen de error se calcular siguiendo la @eq-margen-error, donde $Z$ es el $Z_{score}$ que se considera igual a 2.58 para un nivel de confianza del 99% y n es el n칰mero de muestras.

$$
M = Z \times \left( \frac{\sigma}{\sqrt{n}} \right)
$$ {#eq-margen-error}

Para el c치lculo de los l칤mites inferior y superior del intervalo de confianza, se utilizan las  ecuaciones @eq-lim-sup y @eq-lim-inf:

$$
L_{sup} = EAM + M
$$ {#eq-lim-sup}

$$
L_{inf} = EAM - M
$$ {#eq-lim-inf}


Una vez definido el rango, se lleva a cabo el m칠todo iterativo con un intervalo de 0.01 para probar distintos factores de correcci칩n. Se obtiene el factor de correcci칩n 칩ptimo en 0.47

Para validar el factor de correcci칩n se aplica al conjunto de datos sin eliminar los valores at칤picos siguiendo la @eq-validacion-factor-1, donde $M_c$ son las mediciones corregidas, $M_s$ son las mediciones hechas por el sensor GY-906 y $f_c$ es el factor de correcci칩n

$$
M_c = M_s + f_c
$$ {#eq-validacion-factor-1}


Al Aplicar el factor de correcci칩n al conjunto de datos, el $ME$ disminuye hasta -0.25춿C, mientras que el $EAM$ disminuye hasta XXX춿C. Posteriormente se lleva cabo una segunda campa침a de medici칩n con el objetivo de validar el factor de correcci칩n y se obtienen un total de 25 pares de mediciones. En este nuevo conjunto de datos se obtiene un $EM = -0.3$, el cual al aplicar el factor de correcci칩n disminuye a 0.17. Por otro lado, se obtiene un $EAM = 0.40$, el cual disminuye a 0.34 tras aplicar el factor de correcci칩n. Logrando una mejora en la precisi칩n de las mediciones del sensor.




## L칩gica de programaci칩n {#sec-programaci칩n}

XXX Agregar diagrama de flujo del articulo de Francia y despu칠s desglozarlo por partes. XXX

## Instrucciones de uso {#sec-instrucciones}
1. Integraci칩n con la plataforma iot
2. manejo de los datos

## Validaci칩n {#sec-validaci칩n}